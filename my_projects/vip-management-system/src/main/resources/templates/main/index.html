<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org";>
<head>
    <meta charset="UTF-8" >
    <title>VIP后台管理系统</title>
    <style>
        #navBar2{display: none}
        #navBar3{display: none}
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet"/>
    <link rel="stylesheet" href="//at.alicdn.com/t/font_tnyc012u2rlwstt9.css" media="all" />
    <link th:href="@{/css/main.css}" rel="stylesheet"/>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo"><h3>VIP后台管理系统</h3></div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item"><a href="javascript:loadLeftNavBar(1);">VIP会员管理</a></li>
            <li class="layui-nav-item"><a href="javascript:loadLeftNavBar(2);">其他功能</a></li>
            <li class="layui-nav-item"><a href="javascript:loadLeftNavBar(3);">其他模块</a></li>
            <li class="layui-nav-item">
                <a href="">其它系统</a>
                <dl class="layui-nav-child">
                    <dd><a href="">邮件管理</a></dd>
                    <dd><a href="">消息管理</a></dd>
                    <dd><a href="">授权管理</a></dd>
                </dl>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img th:src="@{/img/touxiang.jpg}" class="layui-nav-img">
                    刘保军
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="">基本资料</a></dd>
                    <dd><a href="">安全设置</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a href="">退出</a></li>
        </ul>
    </div>
<!--    左侧导航1-->
    <div class="layui-side layui-bg-black" id="navBar1">
        <div class="navBar layui-side-scroll" >
            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a href="javascript:;">VIP会员列表1</a>
                    <dl class="layui-nav-child">
                        <!--                        <dd><a th:href="@{'/test'}">列表一</a></dd>-->
                        <dd><a href="javascript:loadNavBarTitleAndPage('普通VIP');">普通VIP</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('超级VIP');">超级VIP</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('帝王VIP');">帝王VIP</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;">VIP会员列表2</a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:loadNavBarTitleAndPage('列表1');">列表1</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('列表2');">列表2</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('VIP会员列表3');">VIP会员列表3</a></li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('VIP会员列表4');">VIP会员列表4</a></li>
            </ul>
        </div>
    </div>

    <!--    左侧导航2-->
    <div class="layui-side layui-bg-black" id="navBar2">
        <div class="navBar layui-side-scroll" >
            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a class="" href="javascript:;">其他功能待定1</a>
                    <dl class="layui-nav-child">
                        <!--                        <dd><a th:href="@{'/test'}">列表一</a></dd>-->
                        <dd><a href="javascript:loadNavBarTitleAndPage('功能待定1');">功能待定1</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('功能待定2');">功能待定2</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('功能待定3');">功能待定3</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('其他功能待定2');">其他功能待定2</a></li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('其他功能待定3');">其他功能待定3</a></li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('其他功能待定4');">其他功能待定4</a></li>
            </ul>
        </div>
    </div>

    <!--    左侧导航3-->
    <div class="layui-side layui-bg-black" id="navBar3">
        <div class="navBar layui-side-scroll" >
            <ul class="layui-nav layui-nav-tree">
                <li class="layui-nav-item">
                    <a class="" href="javascript:;">其他模块1</a>
                    <dl class="layui-nav-child">
                        <!--                        <dd><a th:href="@{'/test'}">列表一</a></dd>-->
                        <dd><a href="javascript:loadNavBarTitleAndPage('模块待定1');">模块待定1</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('模块待定2');">模块待定2</a></dd>
                        <dd><a href="javascript:loadNavBarTitleAndPage('模块待定3');">模块待定3</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('其他模块2');">其他模块2</a></li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('其他模块3');">其他模块3</a></li>
                <li class="layui-nav-item"><a href="javascript:loadNavBarTitleAndPage('其他模块4');">其他模块4</a></li>
            </ul>
        </div>
    </div>

    <div class="layui-body layui-form">
        <div class="layui-tab marg0" lay-filter="bodyTab" id="top_tabs_box">
            <!--导航标题-->
            <div id="navTitle">
                <ul class="layui-tab-title top_tab" id="top_tabs">
                    <li class="layui-this" lay-id="">
                        <i class="iconfont icon-computer"></i>
                        <span th:text="后台首页"></span>
                    </li>
                </ul>
            </div>
            <ul class="layui-nav closeBox">
                <li class="layui-nav-item">
                    <a href="javascript:;"><i class="iconfont icon-caozuo"></i> 页面操作</a>
                    <dl class="layui-nav-child">
                        <dd><a href="javascript:;" class="refresh refreshThis"><i class="layui-icon">&#x1002;</i> 刷新当前</a></dd>
                        <dd><a href="javascript:;" class="closePageOther"><i class="iconfont icon-prohibit"></i> 关闭其他</a></dd>
                        <dd><a href="javascript:;" class="closePageAll"><i class="iconfont icon-guanbi"></i> 关闭全部</a></dd>
                    </dl>
                </li>
            </ul>
            <div class="layui-tab-content clildFrame">
                <div class="layui-tab-item layui-show" id="content">
                    <div th:replace='main/home :: home'></div>
<!--                <iframe id="myiframe" th:replace="main/home1::home1"></iframe>-->
                </div>
            </div>
        </div>
    </div>


<!--    <div class="layui-page-content">-->
<!--        <div class="layui-tab-content">-->
<!--            <div class="layui-tab-item layui-show" id="content">-->
<!--                <div th:include='main/home :: home'></div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

    <div class="layui-footer">
        <!-- 底部固定区域 -->
        <blockquote class="layui-elem-quote layui-quote-nm"><p th:align="center">© 2020 Liu.B.J</p>
        </blockquote>
    </div>
</div>

<script th:src="@{/layui/layui.js}"></script>
<script th:src="@{/layui/admin.js}"></script>
<script th:src="@{/js/leftNav.js}"></script>
<script th:src="@{/js/index.js}"></script>
<script th:src="@{/js/index.js}"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>


<!--<script>-->
<!--    layui.use('element', function(){-->
<!--        var element = layui.element;-->

<!--    });-->
<!--</script>-->

<script>
    function loadNavBarTitleAndPage(navBarTitle) {
        $("#navTitle").load("http://localhost:8080/vip/getNavTitle/"+navBarTitle+"");//导航标题
        $("#content").load("http://localhost:8080/vip/getPage/"+navBarTitle+"");//导航页面
    }
    // 加载左侧导航
    function loadLeftNavBar(index){
        if(index == 1){
            document.getElementById("navBar2").style.display = "none";
            document.getElementById("navBar3").style.display = "none";
            document.getElementById("navBar1").style.display = "block";
        }else if(index == 2){
            document.getElementById("navBar1").style.display = "none";
            document.getElementById("navBar3").style.display = "none";
            document.getElementById("navBar2").style.display = "block";
        }else if(index == 3){
            document.getElementById("navBar1").style.display = "none";
            document.getElementById("navBar2").style.display = "none";
            document.getElementById("navBar3").style.display = "block";
        }

    }
</script>
<script type="text/javascript" th:inline="none">
    // $(document).ready(function(){
    //     alert(123);
    // });
    function doTable(){
        layui.use(['form', 'laypage', 'layer', 'table', 'element'], function(){
            var form = layui.form
                ,laypage = layui.laypage //分页
                ,layer = layui.layer //弹层
                ,table = layui.table //表格
                ,element = layui.element; //元素操作
            var index;
            table.render({
                elem: '#Viptable'
                ,height: 350
                ,url: '/vip/getVipsByPage' //数据接口
                ,method: 'get' //默认：get请求
                ,limit: 5
                ,limits: [5,10,15]
                ,page: true//开启分页
                ,cellMinWidth: 10 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                // ,toolbar: '#toolbarDemo'
                // ,defaultToolbar: ['filter', 'exports', 'print', {
                //     title: '帮助'
                //     ,layEvent: 'LAYTABLE_TIPS'
                //     ,icon: 'layui-icon-tips'
                // }]
                ,request: {
                    pageName: 'page' //页码的参数名称，默认：page
                    ,limitName: 'limit' //每页数据量的参数名，默认：limit
                },response:{
                    statusName: 'code' //数据状态的字段名称，默认：code
                    ,countName: 'count' //数据总数的字段名称，默认：count
                    ,dataName: 'data' //数据列表的字段名称，默认：data
                }
                ,cols: [[ //表头
                    {type: 'checkbox', fixed: 'left',width:50}
                    ,{field: 'cardNo', title: '会员卡号'}
                    ,{field: 'userName', title: '会员名'}
                    ,{field: 'vipStatus', title: '会员状态'}
                    ,{field: 'sex', title: '会员性别'}
                    ,{field: 'isPermanent', title: '是否永久有效'}
                    ,{field: 'surplusAmount', title: '剩余金额'}
                    ,{title: '操作',width:348, align:'center', toolbar: '#tools',width:348}
                ]],
                done:function(res, curr, count) {
                    $("[data-field = 'sex']").children().each(function () {
                        if ($(this).text() == '0') {
                            $(this).text("男");
                        } else if ($(this).text() == '1') {
                            $(this).text("女");
                        }
                    });
                }
            });
            //监听工具条
            table.on('tool(Viptable)', function(obj){
                var data = obj.data;
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值
                if('detail' == obj.event){

                } else if('del' == obj.event){
                    if ('del' == layEvent) { //删除
                        alert("删除");
                        del(data.id);
                    }
                } else if('edit' == layEvent){
                    //编辑
                    //alert(JSON.stringify(data));
                    data.action = 'updateVip';
                    data.request_type = 'post';
                    index = layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        title: "编辑会员信息",
                        area: ['440px', '370px'],
                        shade: 0.4,//背景灰度
                        //skin: 'layui-layer-rim', //加上边框
                        content: $("#popUpdateTest"),//引用的弹出层的页面层的方式加载修改界面表单
                        success: function () {
                            $("#popUpdateTest").setForm(data);
                            layui.form.render();
                        },
                        end: function () {
                            $("#popUpdateTest").hide();
                        }
                    });
                    setFormValue(obj,data);
                    //layer.full(index);
                    //layer.close(index);
                }
            });

            //搜索框
            var $ = layui.$, active = {
                reload: function () {//查询按钮，重载数据
                    var userName = $("#userName").val();
                    var cardNo = $("#cardNo").val();
                    table.reload('Viptable', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        },
                        where: { //查询条件，传值到后台
                            userName: userName,
                            cardNo:cardNo
                        }
                    });
                }
            };

            //搜索按钮绑定事件
            $('.search-term .layui-btn').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            //监听弹出框表单提交，massage是修改界面的表单数据'submit(update_submit),是修改按钮的绑定
            function setFormValue(obj,data){
                form.on('submit(update_submit)', function(data) {
                    var uri = data.field.action;
                    var type = data.field.request_type;
                    var param = data.field;
                    $.ajax({
                        url:'/vip/'+uri,
                        type:type,
                        data:JSON.stringify(param),
                        dataType: "json",
                        contentType: 'application/json;charset=utf-8',
                        success:function (result) {
                            if('0' == result.code){
                                table.reload('Viptable',{
                                    contentType: 'application/x-www-form-urlencoded',
                                    page: {
                                        curr: 1 //重新从第 1 页开始
                                    },
                                    url:'/vip/getVipsByPage',
                                    method:'get'
                                });
                                layer.msg(result.msg, {icon: 1,time:4000});
                            }else {// 失败
                                layer.alert(result.msg, {icon: 2}, function () {
                                    layer.close(index);
                                });
                            }
                        }
                    });
                    //layer.closeAll();//关闭所有的弹出层
                    layer.close(index);//关闭弹出层
                    return false;
                });
            }
        });
    }

    function del(id) {
        layer.open({
            type : 1,
            content : '<div style="padding: 20px 80px;">确定删除记录?</div>',
            btn : [ '确定', '取消' ],
            yes : function(index, layero) {
                $.ajax({
                    url : "/",
                    data : {
                        "id" : id
                    },
                    dataType : "text",
                    success : function(data) {
                        if(data==0){
                            layer.msg("删除成功！");
                            layer.close(index);
                            queryTea();
                        }else{
                            layer.msg("删除失败！");
                        }
                    },
                    error : function() {
                    }
                });
            }
        });

    }

    $.fn.setForm = function (jsonValue) {
        var obj = this;
        $.each(jsonValue, function (name, ival) {
            var $oinput = obj.find("input[name=" + name + "]");
            if ($oinput.attr("type") == "checkbox") {
                if (ival !== null) {
                    var checkboxObj = $("[name=" + name + "]");
                    var checkArray = ival.split(";");
                    for (var i = 0; i < checkboxObj.length; i++) {
                        for (var j = 0; j < checkArray.length; j++) {
                            if (checkboxObj[i].value == checkArray[j]) {
                                checkboxObj[i].click();
                            }
                        }
                    }
                }
            } else if ($oinput.attr("type") == "radio") {
                $oinput.each(function () {
                    var radioObj = $("[name=" + name + "]");
                    for (var i = 0; i < radioObj.length; i++) {
                        if (radioObj[i].value == ival) {
                            radioObj[i].click();
                        }
                    }
                });
            } else if ($oinput.attr("type") == "textarea") {
                obj.find("[name=" + name + "]").html(ival);
            } else {
                obj.find("[name=" + name + "]").val(ival);
            }
        })
    };
</script>
<script type="text/html" id="tools">
    <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<!--弹出框内容-->
<div class="layui-row" id="popUpdateTest" style="display:none;">
    <div class="layui-col-md10">
        <form class="layui-form layui-from-pane" action="" style="margin-top:20px" >
            <!--隐藏字段action，用来区分增加和编辑行为-->
            <input type="hidden" name="action" id="action">
            <!--cardNo-->
            <input type="hidden" name="cardNo" id="cardNo">
            <!--隐藏字段id，用于提供编辑需要的主键-->
            <input type="hidden" name="id" id="id">
            <!--隐藏字段request_type，用于提供请求方式:get,post,put-->
            <input type="hidden" name="request_type" id="request_type">
            <div class="layui-form-item">
                <label class="layui-form-label">会员状态</label>
                <div class="layui-input-block">
                    <select name="vipStatus" lay-filter="vipStatus">
                        <option value="">请选择</option>
                        <option value="有效">有效</option>
                        <option value="无效">无效</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">是否永久有效</label>
                <div class="layui-input-block">
                    <select name="isPermanent" lay-filter="isPermanent">
                        <option value="">请选择</option>
                        <option value="0">是</option>
                        <option value="1">否</option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">会员名</label>
                <div class="layui-input-block">
                    <input type="text" name="userName" lay-verify="required" autocomplete="off" placeholder="请输入会员名" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item" style="margin-top:40px">
                <div class="layui-input-block">
                    <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="update_submit">确认修改</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>
</html>